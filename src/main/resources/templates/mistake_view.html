<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="mistake_view" content="width=device-width, initial-scale=1.0">
    <title>错题详情 - 知错</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#F97316',
                        neutral: {
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827'
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-all;
            }
            .btn-secondary {
                @apply bg-secondary text-white px-4 py-2 rounded-lg hover:bg-secondary/90 transition-all;
            }
            .card-hover {
                @apply hover:shadow-md transition-shadow duration-300;
            }
            .form-input {
                @apply w-full p-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-neutral-800 min-h-screen flex flex-col">
<!-- 顶部导航栏 -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <a href="/mistake" class="flex items-center space-x-2 hover:opacity-80 transition-opacity">
            <div class="text-primary text-2xl">
                <i class="fa fa-book"></i>
            </div>
            <h1 class="text-xl font-bold text-neutral-800">知错</h1>
        </a>

        <!-- 搜索框 - 中等屏幕以上显示 -->
        <div class="hidden md:flex items-center flex-1 max-w-md mx-8">
            <div class="relative w-full">
                <input type="text" placeholder="搜索错题、知识点..." id="topSearchInput"
                       class="w-full pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
            </div>
        </div>

        <nav class="flex items-center space-x-4">
            <a href="/mistake/manage" class="text-neutral-600 hover:text-primary">
                <i class="fa fa-arrow-left mr-1"></i> 返回列表
            </a>
            <div class="relative group">
                <button class="flex items-center space-x-1 p-1 rounded-full hover:bg-neutral-100">
                    <img th:src="${currentUser?.avatar ?: '/images/default-avatar.png'}"
                         alt="用户头像"
                         class="w-8 h-8 rounded-full object-cover">
                    <span class="hidden md:inline font-medium" th:text="${currentUser?.username ?: '未知用户'}">用户名</span>
                </button>
            </div>
        </nav>
    </div>
</header>

<!-- 主内容区 -->
<main class="flex-1 container mx-auto px-4 py-6 pb-16 md:pb-0">
    <div class="max-w-3xl mx-auto">
        <!-- 标题 -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold">错题详情</h2>
            <p class="text-neutral-500 mt-1" id="timeInfo">创建于 未知时间 · 最后编辑于 未知时间</p>        </div>

        <!-- 错题信息卡片 -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-neutral-200 card-hover mb-6">
            <div class="p-5 border-b border-neutral-200">
                <div class="flex flex-wrap gap-3 mb-4">
                    <span class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-700"></span>
                    <span class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-700"></span>
                    <span class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-700"></span>
                    <span class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-700"></span>
                    <span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-700"></span>
                </div>

                <div class="flex flex-wrap md:flex-nowrap justify-between gap-4 text-sm text-neutral-600">
                    <div>
                        <span class="mr-4"><i class="fa fa-exclamation-circle text-yellow-500 mr-1"></i>错误次数：3次</span>
                        <span><i class="fa fa-star text-yellow-500 mr-1"></i></span>
                    </div>
                    <div>
                        <span><i class="fa fa-folder-o mr-1"></i></span>
                    </div>
                </div>
            </div>

            <!-- 题目内容 -->
            <div class="p-5 border-b border-neutral-200">
                <h3 class="font-medium text-neutral-700 mb-3">题目内容</h3>
                <div class="bg-neutral-50 p-4 rounded-lg border border-neutral-200 mb-4">
                    <div id="questionContent">
                        <p>加载中...</p>
                    </div>
                </div>

                <div id="imageContainer" class="mb-4 hidden">
                    <img id="questionImage" src="" alt="题目图片" class="max-h-64 rounded-lg border border-neutral-200">
                </div>
            </div>

            <!-- 答案对比 -->
            <div class="p-5 border-b border-neutral-200">
                <h3 class="font-medium text-neutral-700 mb-3">答案对比</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-red-500 mb-2">我的答案</label>
                        <div class="bg-red-50 p-4 rounded-lg border border-red-100 text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-green-500 mb-2">正确答案</label>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-sm">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 解析与笔记 -->
            <div class="p-5 border-b border-neutral-200">
                <h3 class="font-medium text-neutral-700 mb-3">解析</h3>
                <div class="bg-neutral-50 p-4 rounded-lg border border-neutral-200 mb-6 text-sm">
                </div>

                <h3 class="font-medium text-neutral-700 mb-3">笔记</h3>
                <div class="bg-neutral-50 p-4 rounded-lg border border-neutral-200 text-sm">
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="flex flex-wrap justify-center gap-4">
            <button class="btn-primary flex items-center" onclick="editMistake()">
                <i class="fa fa-pencil mr-2"></i> 编辑错题
            </button>
            <button class="btn-secondary flex items-center" onclick="startPractice()">
                <i class="fa fa-refresh mr-2"></i> 再次练习
            </button>
            <button class="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-all flex items-center" onclick="deleteMistake()">
                <i class="fa fa-trash-o mr-2"></i> 删除错题
            </button>
        </div>
    </div>
    <!-- 编辑错题模态框 -->
    <div id="editModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="p-5 border-b border-neutral-200 flex justify-between items-center">
                <h3 class="text-lg font-bold">编辑错题</h3>
                <button id="closeModalBtn" class="text-neutral-500 hover:text-neutral-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <form id="editMistakeForm" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="editMistakeId">

                    <!-- 科目和章节 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">科目 <span class="text-red-500">*</span></label>
                            <select name="subject" id="editSubject" class="form-input" required>
                                <option value="">请选择科目</option>
                                <option value="数学">数学</option>
                                <option value="语文">语文</option>
                                <option value="英语">英语</option>
                                <option value="物理">物理</option>
                                <option value="化学">化学</option>
                                <option value="生物">生物</option>
                                <option value="历史">历史</option>
                                <option value="地理">地理</option>
                                <option value="政治">政治</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">题型</label>
                            <select name="questionType" id="editQuestionType" class="form-input">
                                <option value="">请选择题型</option>
                                <option value="选择题">选择题</option>
                                <option value="填空题">填空题</option>
                                <option value="解答题">解答题</option>
                                <option value="判断题">判断题</option>
                                <option value="计算题">计算题</option>
                                <option value="应用题">应用题</option>
                                <option value="实验题">实验题</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">章节</label>
                            <input type="text" name="chapter" id="editChapter" placeholder="例如：函数、语法..." class="form-input">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-neutral-700 mb-1">选择错题集</label>
                            <select name="notebookId" id="editNotebookSelect" class="form-input">
                                <option value="">不选择错题集</option>
                            </select>
                        </div>
                    </div>

                    <!-- 题目图片 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-neutral-700 mb-1">题目图片</label>
                        <div class="flex flex-col sm:flex-row gap-4 items-start">
                            <div class="flex-1">
                                <input type="file" name="image" accept="image/*" class="form-input w-full">
                            </div>
                        </div>
                        <div id="editImagePreview" class="mt-2 hidden">
                            <img src="" alt="预览" class="max-h-48 rounded-lg border border-neutral-200">
                        </div>
                    </div>

                    <!-- 题目内容 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-neutral-700 mb-1">题目内容 <span class="text-red-500">*</span></label>
                        <textarea name="question" id="editQuestion" rows="4" placeholder="请输入题目内容..." class="form-input" required></textarea>
                    </div>

                    <!-- 答案部分 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">我的答案</label>
                            <input type="text" name="myAnswer" id="editMyAnswer" placeholder="请输入你的答案..." class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">正确答案 <span class="text-red-500">*</span></label>
                            <input type="text" name="correctAnswer" id="editCorrectAnswer" placeholder="请输入正确答案..." class="form-input" required>
                        </div>
                    </div>

                    <!-- 解析 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-neutral-700 mb-1">解析/备注</label>
                        <textarea name="explanation" id="editExplanation" rows="3" placeholder="请输入解析或备注..." class="form-input"></textarea>
                    </div>

                    <!-- 笔记 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-neutral-700 mb-1">笔记</label>
                        <textarea name="note" id="editNote" rows="2" placeholder="请输入笔记..." class="form-input"></textarea>
                    </div>

                    <!-- 错误次数和难度设置 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">错误次数</label>
                            <input type="number" name="mistakeCount" id="editMistakeCount" min="1" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-1">难度等级</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" name="difficulty" min="1" max="5" value="3" class="w-full" id="editDifficultySlider">
                                <span id="editDifficultyValue" class="text-neutral-700 w-6 text-center">3</span>
                            </div>
                            <div class="flex justify-between text-xs text-neutral-500 mt-1">
                                <span>简单</span>
                                <span>困难</span>
                            </div>
                        </div>
                    </div>

                    <!-- 掌握状态 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-neutral-700 mb-1">掌握状态</label>
                        <select name="isMastered" id="editIsMastered" class="form-input">
                            <option value="false">未掌握</option>
                            <option value="true">已掌握</option>
                        </select>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelEditBtn" class="px-4 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-100 transition-all">
                            取消
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fa fa-save mr-1"></i> 保存修改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- AI咨询浮窗 -->
    <div id="aiAssistant" class="fixed bottom-6 right-6 z-50">
        <div id="aiChatContainer" class="hidden absolute bottom-20 right-0 w-80 h-[500px] bg-white rounded-xl shadow-lg border border-neutral-200 flex flex-col">
            <div class="p-4 border-b border-neutral-200 bg-gradient-to-r from-primary to-blue-500 text-white rounded-t-xl">
                <div class="flex items-center justify-between">
                    <h3 class="font-bold flex items-center">
                        <span class="mr-2">AI助手</span>
                    </h3>
                    <span class="text-xs bg-white/20 px-2 py-1 rounded-full">智能解题助手</span>
                </div>
                <p class="text-xs mt-1 opacity-90">基于当前错题提供专业解答</p>
            </div>
            <div id="aiChatHistory" class="flex-1 overflow-y-auto p-4 text-sm bg-neutral-50">
                <div class="text-center text-neutral-500 py-4">
                    <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="text-primary text-2xl font-bold">AI</span>
                    </div>
                    <p class="font-medium">你好！我是AI助手</p>
                    <p class="text-xs mt-1 px-4">我可以帮你分析错题、解释知识点、提供解题思路</p>
                    <div class="mt-3 text-xs text-left bg-white p-3 rounded-lg border border-neutral-200">
                        <p class="font-medium text-neutral-700 mb-1">你可以问我：</p>
                        <ul class="space-y-1 text-neutral-600">
                            <li>• 这道题的解题思路是什么？</li>
                            <li>• 涉及哪些知识点？</li>
                            <li>• 如何避免类似错误？</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-neutral-200 bg-white">
                <div class="flex">
                    <input type="text"
                           id="aiQuestionInput"
                           placeholder="输入问题，如：解释这道题的解题思路..."
                           class="flex-1 border border-neutral-300 rounded-l-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <button id="askAiBtn"
                            class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-blue-600 transition-all flex items-center">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-xs text-neutral-500 mt-2 text-center">AI助手可能会出错，请注意核实</p>
            </div>
        </div>
        <div class="flex flex-col items-end space-y-2">
            <div id="aiStatusCard" class="hidden bg-white rounded-lg shadow-md border border-neutral-200 p-3 w-64 mr-2">
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <span class="text-primary font-medium text-sm">AI</span>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xs font-medium text-neutral-800">AI助手就绪</h4>
                        <p class="text-xs text-neutral-600 mt-1">点击按钮开始提问</p>
                    </div>
                </div>
            </div>
            <button id="toggleAiChat"
                    class="w-14 h-14 rounded-full bg-gradient-to-br from-primary to-blue-500 text-white flex items-center justify-center shadow-lg hover:from-blue-500 hover:to-blue-600 transition-all transform hover:scale-105">
                <span class="text-white font-medium">AI助手</span>
            </button>
        </div>
    </div>
    <div id="imagePreviewModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center">
        <div class="relative max-w-6xl max-h-[90vh]">
            <img id="previewImage" src="" alt="图片预览" class="max-h-[90vh] object-contain">
            <button id="closePreviewBtn" class="absolute top-4 right-4 text-white bg-black/50 rounded-full p-2 hover:bg-black/75">
                <i class="fa fa-times text-xl"></i>
            </button>
        </div>
    </div>
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-neutral-200 z-50">
        <div class="grid grid-cols-4 py-2">
            <a href="/mistake" class="flex flex-col items-center justify-center py-2 text-primary">
                <i class="fa fa-home text-xl"></i>
                <span class="text-xs mt-1">主页</span>
            </a>
            <a href="/mistake/review" class="flex flex-col items-center justify-center py-2 text-neutral-500">
                <i class="fa fa-refresh text-xl"></i>
                <span class="text-xs mt-1">复习</span>
            </a>
            <a href="/mistake/manage" class="flex flex-col items-center justify-center py-2 text-neutral-500">
                <i class="fa fa-list-alt text-xl"></i>
                <span class="text-xs mt-1">错题</span>
            </a>
            <a href="/notebook/manage" class="flex flex-col items-center justify-center py-2 text-neutral-500">
                <i class="fa fa-book text-xl"></i>
                <span class="text-xs mt-1">错题集</span>
            </a>
        </div>
    </div>
</main>


<script>
    // 页面加载时获取错题详情
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const mistakeId = urlParams.get('id');

        if (mistakeId) {
            loadMistakeDetail(mistakeId);
        }

        const imagePreviewModal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        const questionImage = document.getElementById('questionImage');

        // 点击图片时显示预览
        if (questionImage) {
            questionImage.addEventListener('click', function() {
                previewImage.src = this.src;
                imagePreviewModal.classList.remove('hidden');
                imagePreviewModal.classList.add('flex');
            });
        }

        // 关闭预览
        closePreviewBtn.addEventListener('click', function() {
            imagePreviewModal.classList.add('hidden');
            imagePreviewModal.classList.remove('flex');
        });

        // 点击模态框背景关闭预览
        imagePreviewModal.addEventListener('click', function(e) {
            if (e.target === this) {
                imagePreviewModal.classList.add('hidden');
                imagePreviewModal.classList.remove('flex');
            }
        });
    });

    // 获取错题详情
    function loadMistakeDetail(id) {
        fetch(`/mistake/get/${id}`)
            .then(response => response.json())
            .then(mistake => {
                populateMistakeDetail(mistake);
            })
            .catch(error => {
                console.error('获取错题详情失败:', error);
            });
    }

    // 填充错题详情数据
    function populateMistakeDetail(mistake) {
        // 更新标题信息
        document.querySelector('h2').textContent = '错题详情';
        const timeInfoElement = document.getElementById('timeInfo');
        if (timeInfoElement) {
            timeInfoElement.textContent =
                `创建于 ${formatDate(mistake.createTime)} · 最后编辑于 ${formatDate(mistake.updateTime)}`;
        }

        // 更新标签信息
        const tagsContainer = document.querySelector('.flex.flex-wrap.gap-3.mb-4');
        tagsContainer.innerHTML = '';

        // 科目标签
        if (mistake.subject) {
            const subjectTag = document.createElement('span');
            subjectTag.className = `px-3 py-1 text-sm rounded-full ${getSubjectColor(mistake.subject)}`;
            subjectTag.textContent = mistake.subject;
            tagsContainer.appendChild(subjectTag);
        }

        // 章节标签
        if (mistake.chapter) {
            const chapterTag = document.createElement('span');
            chapterTag.className = 'px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-700';
            chapterTag.textContent = mistake.chapter;
            tagsContainer.appendChild(chapterTag);
        }

        // 题型标签
        if (mistake.questionType) {
            const typeTag = document.createElement('span');
            typeTag.className = 'px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-700';
            typeTag.textContent = mistake.questionType;
            tagsContainer.appendChild(typeTag);
        }

        // 年级标签（如果有的话）
        if (mistake.grade) {
            const gradeTag = document.createElement('span');
            gradeTag.className = 'px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-700';
            gradeTag.textContent = mistake.grade;
            tagsContainer.appendChild(gradeTag);
        }

        // 掌握状态标签
        const masteredTag = document.createElement('span');
        masteredTag.className = `px-3 py-1 text-sm rounded-full ${mistake.isMastered ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        masteredTag.textContent = mistake.isMastered ? '已掌握' : '未掌握';
        tagsContainer.appendChild(masteredTag);

        // 更新统计信息
        const statsContainer = document.querySelector('.flex.flex-wrap.md\\:flex-nowrap.justify-between.gap-4.text-sm.text-neutral-600');
        statsContainer.innerHTML = `
            <div>
                <span class="mr-4"><i class="fa fa-exclamation-circle text-yellow-500 mr-1"></i>错误次数：${mistake.mistakeCount || 0}次</span>
                <span><i class="fa fa-star text-yellow-500 mr-1"></i>难度等级：${mistake.difficulty || '未知'}</span>
            </div>
            <div>
                <span><i class="fa fa-folder-o mr-1"></i>所属错题集：${mistake.notebookName || '无'}</span>
            </div>
        `;

        // 更新题目内容
        const questionContainer = document.querySelector('.bg-neutral-50.p-4.rounded-lg.border.border-neutral-200.mb-4');
        if (questionContainer) {
            questionContainer.innerHTML = `<p>${mistake.question || '无题目内容'}</p>`;
        }

        // 更新图片显示
        const imageContainer = document.getElementById('imageContainer');
        const imageElement = document.getElementById('questionImage');
        if (mistake.questionImage && imageElement) {
            imageElement.src = mistake.questionImage;
            imageContainer.classList.remove('hidden');
        } else if (imageContainer) {
            imageContainer.classList.add('hidden');
        }

        // 更新我的答案
        const myAnswerContainer = document.querySelector('.bg-red-50.p-4.rounded-lg.border.border-red-100.text-sm');
        if (myAnswerContainer) {
            myAnswerContainer.innerHTML = `<p>${mistake.myAnswer || '未填写'}</p>`;
        }

        // 更新正确答案
        const correctAnswerContainer = document.querySelector('.bg-green-50.p-4.rounded-lg.border.border-green-100.text-sm');
        if (correctAnswerContainer) {
            correctAnswerContainer.innerHTML = `<p>${mistake.correctAnswer || '未填写'}</p>`;
        }

        // 更新解析
        const explanationContainer = document.querySelector('.bg-neutral-50.p-4.rounded-lg.border.border-neutral-200.mb-6.text-sm');
        if (explanationContainer) {
            explanationContainer.innerHTML = `<p>${mistake.explanation || '无解析'}</p>`;
        }

        // 更新笔记
        const noteContainers = document.querySelectorAll('.bg-neutral-50.p-4.rounded-lg.border.border-neutral-200.text-sm');
        if (noteContainers.length > 1) {
            noteContainers[1].innerHTML = `<p>${mistake.note || '无笔记'}</p>`;
        }
    }

    // 编辑错题功能
    function editMistake() {
        const urlParams = new URLSearchParams(window.location.search);
        const mistakeId = urlParams.get('id');

        if (!mistakeId) {
            alert('无法获取错题ID');
            return;
        }

        // 发送请求获取错题详细信息
        fetch(`/mistake/get/${mistakeId}`)
            .then(response => response.json())
            .then(mistake => {
                // 填充表单数据
                document.getElementById('editMistakeId').value = mistake.id || '';
                document.getElementById('editSubject').value = mistake.subject || '';
                document.getElementById('editQuestionType').value = mistake.questionType || '';
                document.getElementById('editChapter').value = mistake.chapter || '';
                document.getElementById('editQuestion').value = mistake.question || '';
                document.getElementById('editMyAnswer').value = mistake.myAnswer || '';
                document.getElementById('editCorrectAnswer').value = mistake.correctAnswer || '';
                document.getElementById('editExplanation').value = mistake.explanation || '';
                document.getElementById('editNote').value = mistake.note || '';
                document.getElementById('editMistakeCount').value = mistake.mistakeCount || 1;
                document.getElementById('editDifficultySlider').value = mistake.difficulty || 3;
                document.getElementById('editIsMastered').value = mistake.isMastered ? 'true' : 'false';

                // 更新滑块值显示
                document.getElementById('editDifficultyValue').textContent = mistake.difficulty || 3;

                // 如果有图片，显示预览
                const previewDiv = document.getElementById('editImagePreview');
                if (mistake.questionImage) {
                    previewDiv.innerHTML = `<img src="${mistake.questionImage}" alt="预览" class="max-h-48 rounded-lg border border-neutral-200">`;
                    previewDiv.classList.remove('hidden');
                } else {
                    previewDiv.classList.add('hidden');
                }

                // 显示模态框
                const modal = document.getElementById('editModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                // 加载错题集列表，并在加载完成后设置选中值
                loadEditNotebooksAndSetSelection(mistake.notebookId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取错题信息失败');
            });
    }

    // 动态加载错题集列表到编辑表单，并设置选中值
    function loadEditNotebooksAndSetSelection(selectedNotebookId) {
        fetch('/notebook/list')
            .then(response => response.json())
            .then(notebooks => {
                const select = document.getElementById('editNotebookSelect');
                // 清空现有选项
                select.innerHTML = '<option value="">不选择错题集</option>';

                notebooks.forEach(notebook => {
                    const option = document.createElement('option');
                    option.value = notebook.id;
                    option.textContent = notebook.name;
                    select.appendChild(option);
                });

                // 在选项加载完成后设置选中值
                if (selectedNotebookId) {
                    select.value = selectedNotebookId;
                }
            })
            .catch(error => {
                console.error('加载错题本失败:', error);
            });
    }

    // 开始练习功能
    function startPractice() {
        const urlParams = new URLSearchParams(window.location.search);
        const mistakeId = urlParams.get('id');

        if (mistakeId) {
            // 跳转到练习页面，传递错题ID
            window.location.href = `/mistake/test?id=${mistakeId}`;
        } else {
            alert('无法获取错题信息');
        }
    }

    // 删除错题功能
    function deleteMistake() {
        const urlParams = new URLSearchParams(window.location.search);
        const mistakeId = urlParams.get('id');

        if (!mistakeId) {
            alert('无法获取错题ID');
            return;
        }

        if (confirm('确定要删除这道错题吗？删除后无法恢复。')) {
            fetch(`/mistake/delete/${mistakeId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('错题删除成功');
                        // 删除成功后跳转到错题列表页面
                        window.location.href = '/mistake/manage';
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试');
                });
        }
    }

    // 表单提交事件
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('editMistakeForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            // 如果没有选择新图片但存在原始图片，则使用原始图片路径
            const imageFile = formData.get('image');
            const originalImagePath = document.getElementById('originalImagePath');

            if ((!imageFile || imageFile.size === 0) && originalImagePath && originalImagePath.value) {
                // 创建一个新的FormData对象，避免覆盖原始图片
                const newFormData = new FormData();

                // 复制所有表单数据
                for (let [key, value] of formData.entries()) {
                    // 跳过空的图片字段
                    if (key !== 'image' || (value && value.size > 0)) {
                        newFormData.append(key, value);
                    }
                }

                // 添加原始图片路径作为参数
                newFormData.append('keepOriginalImage', 'true');

                submitForm(newFormData);
            } else {
                submitForm(formData);
            }
        });

        function submitForm(formData) {
            fetch('/mistake/update', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('错题更新成功');
                        closeModal();
                        loadMistakes(); // 重新加载错题列表
                    } else {
                        alert('更新失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('更新失败，请重试');
                });
        }

        // 绑定滑块事件
        document.getElementById('editDifficultySlider').addEventListener('input', function() {
            document.getElementById('editDifficultyValue').textContent = this.value;
        });

        // 关闭模态框事件
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('cancelEditBtn').addEventListener('click', closeModal);

        // 点击模态框背景关闭
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    });

    // 关闭模态框
    function closeModal() {
        const modal = document.getElementById('editModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // 添加AI助手功能
    document.addEventListener('DOMContentLoaded', function() {
        const toggleAiChat = document.getElementById('toggleAiChat');
        const aiChatContainer = document.getElementById('aiChatContainer');
        const askAiBtn = document.getElementById('askAiBtn');
        const aiQuestionInput = document.getElementById('aiQuestionInput');
        const aiChatHistory = document.getElementById('aiChatHistory');

        // 切换AI聊天窗口显示状态
        toggleAiChat.addEventListener('click', function() {
            aiChatContainer.classList.toggle('hidden');
        });

        // 点击窗口外部关闭AI聊天窗口
        document.addEventListener('click', function(event) {
            if (!aiChatContainer.classList.contains('hidden') &&
                !aiChatContainer.contains(event.target) &&
                event.target !== toggleAiChat &&
                !toggleAiChat.contains(event.target)) {
                aiChatContainer.classList.add('hidden');
            }
        });

        // 发送问题给AI
        askAiBtn.addEventListener('click', sendQuestionToAi);
        aiQuestionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestionToAi();
            }
        });

        // 发送问题给AI
        function sendQuestionToAi() {
            const question = aiQuestionInput.value.trim();
            if (!question) return;

            // 显示用户问题
            addMessageToChat('user', question);
            aiQuestionInput.value = '';

            // 显示正在输入状态
            const thinkingIndicator = document.createElement('div');
            thinkingIndicator.id = 'aiThinking';
            thinkingIndicator.className = 'flex items-center text-neutral-500 text-sm my-2';
            thinkingIndicator.innerHTML = '<span class="flex h-2 w-2 mr-2"><span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-secondary opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-secondary"></span></span>AI正在思考...';
            aiChatHistory.appendChild(thinkingIndicator);
            aiChatHistory.scrollTop = aiChatHistory.scrollHeight;

            // 获取当前错题ID
            const urlParams = new URLSearchParams(window.location.search);
            const mistakeId = urlParams.get('id');

            // 发送请求到AI服务
            fetch('/mistake/ask-ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mistakeId: mistakeId,
                    question: question
                })
            })
                .then(response => response.json())
                .then(data => {
                    // 移除正在输入状态
                    thinkingIndicator.remove();

                    if (data.success) {
                        addMessageToChat('ai', data.answer);
                    } else {
                        addMessageToChat('ai', '抱歉，我无法回答这个问题。请稍后再试。');
                    }
                })
                .catch(error => {
                    // 移除正在输入状态
                    thinkingIndicator.remove();
                    console.error('AI请求失败:', error);
                    addMessageToChat('ai', '抱歉，我遇到了一些问题。请稍后再试。');
                });
        }

        // 添加消息到聊天窗口
        function addMessageToChat(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = `mb-3 ${sender === 'user' ? 'text-right' : ''}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `inline-block p-3 rounded-lg max-w-[80%] ${
                sender === 'user'
                    ? 'bg-primary text-white rounded-tr-none'
                    : 'bg-white border border-neutral-200 rounded-tl-none'
            }`;
            messageBubble.textContent = message;

            messageElement.appendChild(messageBubble);
            aiChatHistory.appendChild(messageElement);
            aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
        }
    });

    // 根据科目获取颜色
    function getSubjectColor(subject) {
        const colors = {
            '数学': 'bg-blue-100 text-blue-700',
            '语文': 'bg-red-100 text-red-700',
            '英语': 'bg-green-100 text-green-700',
            '物理': 'bg-purple-100 text-purple-700',
            '化学': 'bg-yellow-100 text-yellow-700'
        };
        return colors[subject] || 'bg-gray-100 text-gray-700';
    }

    //格式化日期
    function formatDate(dateString) {
        if (!dateString) return '未知时间';
        try {
            // 处理不同格式的日期字符串
            let date;
            if (typeof dateString === 'string' && dateString.includes('T')) {
                // ISO格式日期
                date = new Date(dateString);
            } else if (typeof dateString === 'string') {
                // MySQL时间戳格式
                date = new Date(dateString.replace(' ', 'T'));
            } else {
                date = new Date(dateString);
            }

            // 检查日期是否有效
            if (isNaN(date.getTime())) {
                return '未知时间';
            }

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        } catch (e) {
            console.error('日期格式化错误:', e);
            return '未知时间';
        }
    }
    // 搜索功能
    document.getElementById('topSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                window.location.href = `/mistake/manage?search=${encodeURIComponent(query)}`;
            }
        }
    });
</script>

</body>
</html>
